<%= form_with(model: distribution, class: "space-y-6") do |form| %>
  <% if distribution.errors.any? %>
    <div class="p-4 bg-red-50 text-red-500 rounded mb-6">
      <h2><%= pluralize(distribution.errors.count, "error") %> prohibited this distribution from being saved:</h2>
      <ul class="list-disc pl-5 mt-2">
        <% distribution.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :name, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
      <%= form.text_field :name, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white" %>
    </div>

    <div>
      <%= form.label :company_id, "Company", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
      <%= form.collection_select :company_id, @companies, :id, :name, { include_blank: "Select a company" }, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white" %>
    </div>
  </div>

  <div>
    <%= form.label :description, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
    <%= form.text_area :description, rows: 3, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white" %>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <%= form.label :endpoint_url, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
      <%= form.text_field :endpoint_url, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white" %>
    </div>

    <div>
      <%= form.label :authentication_token, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
      <%= form.text_field :authentication_token, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white" %>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div>
      <%= form.label :request_method, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
      <%= form.select :request_method, Distribution.request_methods.keys.map { |m| [m.titleize, m] }, {}, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white" %>
    </div>

    <div>
      <%= form.label :request_format, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
      <%= form.select :request_format, Distribution.request_formats.keys.map { |f| [f.titleize, f] }, {}, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white" %>
    </div>

    <div>
      <%= form.label :status, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
      <%= form.select :status, Distribution.statuses.keys.map { |s| [s.titleize, s] }, {}, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white" %>
    </div>
  </div>

  <div>
    <%= form.label :template, "JSON Template (optional)", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
    <%= form.text_area :template, rows: 5, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50 font-mono dark:bg-gray-800 dark:border-gray-700 dark:text-white", placeholder: '{"field1": "{field1}", "nested": {"field2": "{field2}"}}' %>
    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Use {fieldName} placeholders for dynamic values. If empty, a default format will be used based on the field mappings.</p>
  </div>

  <div class="border rounded-md p-4 dark:border-gray-700">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-medium text-gray-900 dark:text-white">HTTP Headers</h3>
    </div>

    <div id="headers" class="space-y-4">
      <%= form.fields_for :headers do |header_form| %>
        <div class="nested-fields grid grid-cols-5 gap-4">
          <div class="col-span-2">
            <%= header_form.label :name, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= header_form.text_field :name, list: "common_headers", class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white" %>
          </div>
          
          <div class="col-span-2">
            <%= header_form.label :value, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" %>
            <%= header_form.text_field :value, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white" %>
          </div>
          
          <div class="flex items-end">
            <% if header_form.object.persisted? %>
              <%= header_form.check_box :_destroy, class: "hidden" %>
              <button type="button" class="remove-header px-3 py-2 text-sm text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                <i class="fas fa-trash-alt"></i>
              </button>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <datalist id="common_headers">
      <% Header.common_headers.each do |header| %>
        <option value="<%= header %>">
      <% end %>
    </datalist>

    <div class="mt-4">
      <button type="button" id="add-header" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
        <i class="fas fa-plus mr-2"></i> Add Header
      </button>
    </div>
  </div>

  <div class="flex justify-end space-x-3">
    <%= link_to "Cancel", distributions_path, class: "inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600" %>
    <%= form.submit class: "inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500" %>
  </div>
<% end %>

<script>
  document.addEventListener('turbo:load', function() {
    initHeadersForm();
  });

  function initHeadersForm() {
    const addHeaderButton = document.getElementById('add-header');
    if (addHeaderButton) {
      addHeaderButton.addEventListener('click', function() {
        const headersContainer = document.getElementById('headers');
        const timestamp = new Date().getTime();
        const newHeaderHtml = `
          <div class="nested-fields grid grid-cols-5 gap-4">
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name</label>
              <input type="text" name="distribution[headers_attributes][${timestamp}][name]" list="common_headers" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Value</label>
              <input type="text" name="distribution[headers_attributes][${timestamp}][value]" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
            </div>
            <div class="flex items-end">
              <button type="button" class="remove-header px-3 py-2 text-sm text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>
        `;
        headersContainer.insertAdjacentHTML('beforeend', newHeaderHtml);
        initRemoveHeaderButtons();
      });

      initRemoveHeaderButtons();
    }
  }

  function initRemoveHeaderButtons() {
    document.querySelectorAll('.remove-header').forEach(button => {
      button.addEventListener('click', function() {
        const nestedFields = this.closest('.nested-fields');
        const destroyCheckbox = nestedFields.querySelector('input[type="checkbox"][name*="_destroy"]');
        
        if (destroyCheckbox) {
          destroyCheckbox.checked = true;
          nestedFields.style.display = 'none';
        } else {
          nestedFields.remove();
        }
      });
    });
  }
</script>