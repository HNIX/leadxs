<% content_for :title, "Compliance Details" %>

<div class="container mx-auto px-4 py-6">
  <div class="mb-6">
    <%= link_to compliance_path, class: "text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 inline-flex items-center" do %>
      <svg class="mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
      </svg>
      Back to compliance records
    <% end %>
  </div>

  <div class="border-b border-gray-200 dark:border-gray-700 pb-5 mb-6 flex items-center justify-between">
    <h1 class="text-2xl font-bold leading-7 text-gray-900 dark:text-gray-100">
      <%= @record.class.name %> Compliance Details
    </h1>
    <div class="flex space-x-3">
      <%= link_to compliance_history_path(record_type: @record.class.name.underscore, record_id: @record.id), class: "inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 focus:ring-indigo-500" do %>
        <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
        </svg>
        View History
      <% end %>
      
      <% if @record.class.name == 'Lead' %>
        <%= link_to compliance_consent_path(record_type: @record.class.name.underscore, record_id: @record.id), class: "inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 focus:ring-indigo-500" do %>
          <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
          </svg>
          Manage Consent
        <% end %>
      <% end %>
      
      <%= link_to compliance_export_path(record_type: @record.class.name.underscore, record_id: @record.id, format: :json), class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800 focus:ring-indigo-500" do %>
        <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        Export Report
      <% end %>
    </div>
  </div>

  <!-- Record Details -->
  <div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg mb-8">
    <div class="px-4 py-5 sm:px-6">
      <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">
        Record Information
      </h3>
      <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">
        Details about the <%= @record.class.name.titleize %> record.
      </p>
    </div>
    <div class="border-t border-gray-200 dark:border-gray-700">
      <dl>
        <% if @record.is_a?(Lead) %>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Lead ID</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.id %></dd>
          </div>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Unique ID</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.unique_id %></dd>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Campaign</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.campaign.name %></dd>
          </div>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Status</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-<%= @record.status == 'distributed' ? 'green' : (@record.status == 'error' ? 'red' : 'blue') %>-100 dark:bg-<%= @record.status == 'distributed' ? 'green' : (@record.status == 'error' ? 'red' : 'blue') %>-900/30 text-<%= @record.status == 'distributed' ? 'green' : (@record.status == 'error' ? 'red' : 'blue') %>-800 dark:text-<%= @record.status == 'distributed' ? 'green' : (@record.status == 'error' ? 'red' : 'blue') %>-300">
                <%= @record.status.humanize %>
              </span>
            </dd>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Created At</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.created_at.strftime("%B %d, %Y at %I:%M %p") %></dd>
          </div>
          <% if @record.source.present? %>
            <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Source</dt>
              <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.source.name %></dd>
            </div>
          <% end %>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">IP Address</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.ip_address || "Not recorded" %></dd>
          </div>

        <% elsif @record.is_a?(ConsentRecord) %>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Consent Type</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.consent_type.humanize %></dd>
          </div>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Status</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">
              <% if @record.active? %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">Active</span>
              <% elsif @record.revoked? %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">Revoked</span>
              <% elsif @record.expires_at && @record.expires_at < Time.current %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300">Expired</span>
              <% else %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300">Unknown</span>
              <% end %>
            </dd>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Related Lead</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">
              <%= link_to "Lead ##{@record.lead_id} (#{@record.lead.unique_id})", compliance_show_path(record_type: 'lead', record_id: @record.lead_id), class: "text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300" %>
            </dd>
          </div>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Consented At</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.consented_at.strftime("%B %d, %Y at %I:%M %p") %></dd>
          </div>
          <% if @record.expires_at.present? %>
            <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Expires At</dt>
              <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.expires_at.strftime("%B %d, %Y at %I:%M %p") %></dd>
            </div>
          <% end %>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">IP Address</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.ip_address %></dd>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">User Agent</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.user_agent || "Not recorded" %></dd>
          </div>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Proof Token</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><code class="text-xs bg-gray-100 dark:bg-gray-800 p-1 rounded"><%= @record.proof_token %></code></dd>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Consent Text</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">
              <div class="border border-gray-200 dark:border-gray-600 rounded-md p-4 bg-gray-50 dark:bg-gray-800">
                <%= simple_format(@record.consent_text) %>
              </div>
            </dd>
          </div>
          <% if @record.revoked? %>
            <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Revoked At</dt>
              <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.revoked_at.strftime("%B %d, %Y at %I:%M %p") %></dd>
            </div>
            <% if @record.revocation_reason.present? %>
              <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Revocation Reason</dt>
                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.revocation_reason %></dd>
              </div>
            <% end %>
          <% end %>

        <% elsif @record.is_a?(Distribution) %>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Distribution Name</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.name %></dd>
          </div>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Status</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-<%= @record.status == 'active' ? 'green' : 'gray' %>-100 dark:bg-<%= @record.status == 'active' ? 'green' : 'gray' %>-900/30 text-<%= @record.status == 'active' ? 'green' : 'gray' %>-800 dark:text-<%= @record.status == 'active' ? 'green' : 'gray' %>-300">
                <%= @record.status.humanize %>
              </span>
            </dd>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Company</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.company.name %></dd>
          </div>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Endpoint URL</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><code class="text-xs bg-gray-100 dark:bg-gray-800 p-1 rounded"><%= @record.endpoint_url %></code></dd>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Request Method</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.request_method.upcase %></dd>
          </div>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Request Format</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.request_format.upcase %></dd>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Metadata Requirements</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.metadata_requirements.humanize %></dd>
          </div>
        <% elsif @record.is_a?(ComplianceRecord) %>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Event Type</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-<%= @record.event_type == 'consent' ? 'green' : (@record.event_type == 'lead_processing' ? 'blue' : (@record.event_type == 'distribution' ? 'purple' : (@record.event_type == 'validation' ? 'yellow' : 'gray'))) %>-100 dark:bg-<%= @record.event_type == 'consent' ? 'green' : (@record.event_type == 'lead_processing' ? 'blue' : (@record.event_type == 'distribution' ? 'purple' : (@record.event_type == 'validation' ? 'yellow' : 'gray'))) %>-900/30 text-<%= @record.event_type == 'consent' ? 'green' : (@record.event_type == 'lead_processing' ? 'blue' : (@record.event_type == 'distribution' ? 'purple' : (@record.event_type == 'validation' ? 'yellow' : 'gray'))) %>-800 dark:text-<%= @record.event_type == 'consent' ? 'green' : (@record.event_type == 'lead_processing' ? 'blue' : (@record.event_type == 'distribution' ? 'purple' : (@record.event_type == 'validation' ? 'yellow' : 'gray'))) %>-300">
                <%= @record.event_type.humanize %>
              </span>
            </dd>
          </div>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Action</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.action.humanize %></dd>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Occurred At</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.occurred_at.strftime("%B %d, %Y at %I:%M %p") %></dd>
          </div>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">IP Address</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.ip_address || "Not recorded" %></dd>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">User Agent</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.user_agent || "Not recorded" %></dd>
          </div>
          <% if @record.data.present? && !@record.data.empty? %>
            <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Event Data</dt>
              <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">
                <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md p-3 text-xs text-gray-700 dark:text-gray-300 font-mono overflow-auto">
                  <pre><%= JSON.pretty_generate(@record.data) %></pre>
                </div>
              </dd>
            </div>
          <% end %>
          <% if @record.record.present? %>
            <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
              <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Related Record</dt>
              <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">
                <%= link_to "#{@record.record.class.name} ##{@record.record_id}", compliance_show_path(record_type: @record.record.class.name.underscore, record_id: @record.record_id), class: "text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300" %>
              </dd>
            </div>
          <% end %>
        <% elsif @record.is_a?(Account) %>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Account Name</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.name %></dd>
          </div>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Account Owner</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">
              <% if @record.owner %>
                <%= @record.owner.name %>
              <% else %>
                No owner assigned
              <% end %>
            </dd>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Created At</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.created_at.strftime("%B %d, %Y at %I:%M %p") %></dd>
          </div>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Domain</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.domain || "No domain set" %></dd>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Billing Email</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.billing_email || @record.owner&.email || "No billing email set" %></dd>
          </div>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Users</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.users.count %> users</dd>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Subscription Status</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2">
              <% if @record.respond_to?(:payment_processor?) && @record.payment_processor? %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">
                  Active Subscription
                </span>
              <% elsif @record.respond_to?(:subscriptions) && @record.subscriptions.active.any? %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">
                  Active Subscription
                </span>
              <% else %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300">
                  No Active Subscription
                </span>
              <% end %>
            </dd>
          </div>
        <% else %>
          <!-- Generic display for other record types -->
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Record ID</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.id %></dd>
          </div>
          <div class="bg-white dark:bg-gray-700 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Record Type</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.class.name %></dd>
          </div>
          <div class="bg-gray-50 dark:bg-gray-800 px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-300">Created At</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-gray-100 sm:mt-0 sm:col-span-2"><%= @record.created_at.strftime("%B %d, %Y at %I:%M %p") %></dd>
          </div>
        <% end %>
      </dl>
    </div>
  </div>

  <!-- Recent Compliance History -->
  <div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg">
    <div class="px-4 py-5 sm:px-6 flex items-center justify-between">
      <div>
        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">
          Recent Compliance History
        </h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">
          Last 10 compliance events for this record.
        </p>
      </div>
      <%= link_to compliance_history_path(record_type: @record.class.name.underscore, record_id: @record.id), class: "text-sm text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300" do %>
        View full history
      <% end %>
    </div>
    <div class="border-t border-gray-200 dark:border-gray-700">
      <% if @compliance_history.present? %>
        <ul class="divide-y divide-gray-200 dark:divide-gray-700 list-none">
          <% @compliance_history.first(10).each do |event| %>
            <li class="px-4 py-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <% case event.event_type %>
                  <% when 'lead_processing' %>
                    <span class="inline-flex items-center mr-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300">Lead</span>
                  <% when 'consent' %>
                    <span class="inline-flex items-center mr-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">Consent</span>
                  <% when 'distribution' %>
                    <span class="inline-flex items-center mr-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-300">Distribution</span>
                  <% when 'data_access' %>
                    <span class="inline-flex items-center mr-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300">Data Access</span>
                  <% when 'validation' %>
                    <span class="inline-flex items-center mr-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">Validation</span>
                  <% when 'system' %>
                    <span class="inline-flex items-center mr-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 dark:bg-indigo-900/30 text-indigo-800 dark:text-indigo-300">System</span>
                  <% else %>
                    <span class="inline-flex items-center mr-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300"><%= event.event_type.titleize %></span>
                  <% end %>
                  <span class="text-sm font-medium text-gray-900 dark:text-gray-100"><%= event.action.humanize %></span>
                </div>
                <span class="text-sm text-gray-500 dark:text-gray-400"><%= event.occurred_at.strftime("%b %d, %Y at %I:%M %p") %></span>
              </div>
              <% if event.data.present? && !event.data.empty? %>
                <div class="mt-2">
                  <a 
                    href="#" 
                    class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 flex items-center"
                    onclick="event.preventDefault(); document.getElementById('event-data-<%= event.id %>').classList.toggle('hidden');"
                  >
                    <svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                    Show details
                  </a>
                  <div id="event-data-<%= event.id %>" class="hidden mt-2 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md p-3 text-xs text-gray-700 dark:text-gray-300 font-mono overflow-auto">
                    <pre><%= JSON.pretty_generate(event.data) %></pre>
                  </div>
                </div>
              <% end %>
              <% if event.record.present? && event.record != @record %>
                <div class="mt-1">
                  <span class="text-sm text-gray-500 dark:text-gray-400">
                    Related: 
                    <%= link_to "#{event.record.class.name} ##{event.record_id}", compliance_show_path(record_type: event.record.class.name.underscore, record_id: event.record_id), class: "text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300" %>
                  </span>
                </div>
              <% end %>
            </li>
          <% end %>
        </ul>
      <% else %>
        <div class="px-4 py-5 text-center text-gray-500 dark:text-gray-400">
          No compliance events found for this record.
        </div>
      <% end %>
    </div>
  </div>

  <% if @record.is_a?(Lead) && @record.consent_records.exists? %>
    <!-- Consent Records for Lead -->
    <div class="mt-8 bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg">
      <div class="px-4 py-5 sm:px-6 flex items-center justify-between">
        <div>
          <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">
            Consent Records
          </h3>
          <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">
            Consent records associated with this lead.
          </p>
        </div>
        <%= link_to compliance_consent_path(record_type: @record.class.name.underscore, record_id: @record.id), class: "text-sm text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300" do %>
          Manage consent
        <% end %>
      </div>
      <div class="border-t border-gray-200 dark:border-gray-700">
        <ul class="divide-y divide-gray-200 dark:divide-gray-700 list-none">
          <% @record.consent_records.order(created_at: :desc).each do |consent| %>
            <li class="px-4 py-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <% if consent.active? %>
                    <span class="inline-flex items-center mr-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">Active</span>
                  <% elsif consent.revoked? %>
                    <span class="inline-flex items-center mr-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">Revoked</span>
                  <% elsif consent.expires_at && consent.expires_at < Time.current %>
                    <span class="inline-flex items-center mr-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300">Expired</span>
                  <% else %>
                    <span class="inline-flex items-center mr-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300">Unknown</span>
                  <% end %>
                  <span class="text-sm font-medium text-gray-900 dark:text-gray-100"><%= consent.consent_type.humanize %></span>
                </div>
                <div class="flex items-center space-x-4">
                  <span class="text-sm text-gray-500 dark:text-gray-400">
                    <%= consent.consented_at.strftime("%b %d, %Y") %>
                    <% if consent.expires_at.present? %>
                      • Expires: <%= consent.expires_at.strftime("%b %d, %Y") %>
                    <% end %>
                  </span>
                  <%= link_to compliance_show_path(record_type: 'consent_record', record_id: consent.id), class: "text-sm text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300" do %>
                    View
                  <% end %>
                </div>
              </div>
            </li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <% if @record.is_a?(Lead) && @record.api_requests.exists? %>
    <!-- Distribution History for Lead -->
    <div class="mt-8 bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg">
      <div class="px-4 py-5 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">
          Distribution History
        </h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">
          API requests made for this lead.
        </p>
      </div>
      <div class="border-t border-gray-200 dark:border-gray-700">
        <ul class="divide-y divide-gray-200 dark:divide-gray-700">
          <% @record.api_requests.order(created_at: :desc).each do |request| %>
            <li class="px-4 py-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <% if request.successful? %>
                    <span class="inline-flex items-center mr-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">Success</span>
                  <% else %>
                    <span class="inline-flex items-center mr-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">Failed</span>
                  <% end %>
                  <span class="text-sm font-medium text-gray-900 dark:text-gray-100">
                    <%= request.requestable_type == 'Distribution' ? request.requestable.name : request.requestable_type %>
                  </span>
                </div>
                <div class="flex items-center space-x-4">
                  <span class="text-sm text-gray-500 dark:text-gray-400">
                    <%= request.sent_at&.strftime("%b %d, %Y at %I:%M %p") || request.created_at.strftime("%b %d, %Y at %I:%M %p") %>
                    <% if request.response_code.present? %>
                      • Response: <%= request.response_code %>
                    <% end %>
                  </span>
                </div>
              </div>
              <% if request.error.present? %>
                <div class="mt-1 text-sm text-red-600 dark:text-red-400">
                  Error: <%= request.error %>
                </div>
              <% end %>
            </li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>
</div>